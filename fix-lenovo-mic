#!/usr/bin/env python3
#
# fix-lenovo-mic - Fix Lenovo microphone issues using HDA hardware interface
#
# This script fixes microphone issues on some Lenovo laptops by directly
# accessing the HDA (High Definition Audio) hardware interface to set
# amplifier gain and mute settings.
#
# Usage: fix-lenovo-mic
#
# WARNING: This script directly accesses hardware and should be used carefully.

import os
import struct
from fcntl import ioctl

# HDA hardware interface constants
IOCTL_INFO = 0x80dc4801
IOCTL_PVERSION = 0x80044810
IOCTL_VERB_WRITE = 0xc0084811

def set(nid, verb, param):
    """Send a verb command to the HDA node."""
    verb = (nid << 24) | (verb << 8) | param
    res = ioctl(FD, IOCTL_VERB_WRITE, struct.pack('II', verb, 0))

def show_help():
    print(f"""fix-lenovo-mic - Fix Lenovo microphone issues using HDA hardware interface

This script fixes microphone issues on some Lenovo laptops by directly
accessing the HDA (High Definition Audio) hardware interface to set
amplifier gain and mute settings.

Usage: {os.path.basename(__file__)}
       sudo {os.path.basename(__file__)}

WARNING: This script directly accesses hardware and should be used carefully.
         Run with root privileges.

Examples:
  sudo {os.path.basename(__file__)}
""")

if len(os.sys.argv) > 1 and os.sys.argv[1] in ['-h', '--help']:
    show_help()
    exit(0)

# Open HDA hardware interface
try:
    FD = os.open("/dev/snd/hwC0D0", os.O_RDONLY)
except OSError:
    print("Error: Could not open HDA hardware interface at /dev/snd/hwC0D0")
    print("Make sure you have the required audio hardware and run as root.")
    exit(1)

# Verify HDA interface
info = struct.pack('Ii64s80si64s', 0, 0, b'', b'', 0, b'')
res = ioctl(FD, IOCTL_INFO, info)
name = struct.unpack('Ii64s80si64s', res)[3]
if not name.decode().startswith('HDA Codec'):
    os.close(FD)
    raise IOError("unknown HDA hwdep interface")

# Check HDA version
res = ioctl(FD, IOCTL_PVERSION, struct.pack('I', 0))
version = struct.unpack('I', res)[0]
if version < 0x00010000:    # 1.0.0
    os.close(FD)
    raise IOError("unknown HDA hwdep version")

print("HDA interface verified, applying microphone fix...")

# initialization sequence starts here...
# Set amplifier gain/mute for node 0x08
set(0x08, 0x300, 0x50bf) # 0x080350bf (SET_AMP_GAIN_MUTE)

# Close HDA interface
os.close(FD)

print("Lenovo microphone fix applied successfully.")
