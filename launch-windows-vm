#!/bin/bash
#
# launch-windows-vm - Launch Windows 10 VM with QEMU/KVM
#
# This script launches a Windows 10 VM with detailed configuration
# for graphics, networking, and USB passthrough.

show_help() {
    cat << EOF
launch-windows-vm - Launch Windows 10 VM with QEMU/KVM

This script launches a Windows 10 VM with detailed configuration
for graphics, networking, and USB passthrough.

Usage: $(basename "$0")

Configuration:
  - 4GB RAM, 2 CPU cores
  - KVM acceleration enabled
  - OVMF UEFI firmware
  - VirtIO GPU with virgl support
  - Sound and network configuration
  - USB 2.0 controllers
  - SPICE USB redirection for devices
  - RDP port forwarding to localhost:3389

Requirements:
  - QEMU with KVM support
  - Windows 10 image at /home/ochi/VMs/Win10/Win10.qcow2
  - OVMF firmware files
  - Appropriate hardware support for virtualization

Examples:
  $(basename "$0")

EOF
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_help
    exit 0
fi

# Check for KVM support
if [ ! -e /dev/kvm ] || [ ! -r /dev/kvm ] || [ ! -w /dev/kvm ]; then
    echo "Error: KVM not accessible. Check virtualization support and permissions."
    exit 1
fi

# Check for Windows image
if [ ! -f "/home/ochi/VMs/Win10/Win10.qcow2" ]; then
    echo "Error: Windows image not found at /home/ochi/VMs/Win10/Win10.qcow2"
    echo "Update script with correct path or create the image first."
    exit 1
fi

echo "Launching Windows 10 VM..."
echo "RDP will be available at localhost:3389"

qemu-system-x86_64 \
-enable-kvm \
-m 4000 \
-smp 2 \
-cpu host \
-device virtio-vga,virgl=on \
-display gtk,gl=on \
-name guest=RDPWindows,debug-threads=on \
-drive file=/usr/share/ovmf/x64/OVMF_CODE.fd,if=pflash,format=raw,unit=0,readonly=on  \
-drive file=/home/ochi/VMs/Win10/UEFI/OVMF_VARS.fd,if=pflash,format=raw,unit=1  \
-machine pc-q35-5.1,accel=kvm \
-uuid 28cb4d35-f230-43b0-8414-23eef86948c6 \
-boot menu=on,strict=on \
-device ich9-intel-hda,id=sound0,bus=pcie.0,addr=0x1b \
-device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \
-netdev user,id=mynet.0,net=10.0.10.0/24,hostfwd=tcp::3389-:3389 \
-device virtio-net,netdev=mynet.0  \
-sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on \
-drive file=/home/ochi/VMs/Win10/Win10.qcow2,if=virtio \
-device ich9-usb-ehci1,id=usb \
-device ich9-usb-uhci1,masterbus=usb.0,firstport=0,multifunction=on \
-device ich9-usb-uhci2,masterbus=usb.0,firstport=2 \
-device ich9-usb-uhci3,masterbus=usb.0,firstport=4 \
-chardev spicevmc,name=usbredir,id=usbredirchardev1 -device usb-redir,chardev=usbredirchardev1,id=usbredirdev1 \
-chardev spicevmc,name=usbredir,id=usbredirchardev2 -device usb-redir,chardev=usbredirchardev2,id=usbredirdev2 \
-chardev spicevmc,name=usbredir,id=usbredirchardev3 -device usb-redir,chardev=usbredirchardev3,id=usbredirdev3

echo "Windows VM closed."
