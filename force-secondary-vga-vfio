#!/bin/bash
#
# force-secondary-vga-vfio - Force secondary VGA to use VFIO driver
#
# This script assigns specific PCI devices to the VFIO driver for GPU passthrough.

show_help() {
    cat << EOF
force-secondary-vga-vfio - Force secondary VGA to use VFIO driver

This script assigns specific PCI devices to the VFIO driver for GPU passthrough.
It's configured for specific hardware devices (0000:02:00.0 and 0000:02:00.1).

Usage: sudo $(basename "$0")

Configuration:
  - PCI devices: 0000:02:00.0, 0000:02:00.1
  - Target driver: vfio-pci

WARNING: This script requires root privileges and directly manipulates
         PCI devices. Ensure you know what you're doing before running.

Examples:
  sudo $(basename "$0")

EOF
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_help
    exit 0
fi

# Check for root privileges before manipulating PCI devices
if [[ $EUID -ne 0 ]]; then
  echo "This script requires root privileges to manipulate PCI devices."
  exit 1
fi

DEVS="0000:02:00.0 0000:02:00.1"

for DEV in $DEVS; do
    echo "vfio-pci" > /sys/bus/pci/devices/$DEV/driver_override
done

modprobe -i vfio-pci
