#!/bin/bash
#
# sort-by-date-backup - Organize files by modification date with backup handling
#
# This script sorts files by date, handling backup files by renaming and organizing
# them into date-based directories.

show_help() {
    cat << EOF
sort-by-date-backup - Organize files by modification date with backup handling

This script sorts files by date, handling backup files by renaming and organizing
them into date-based directories.

Usage: $(basename "$0")

Process:
  1. Moves all files to a workdir directory with backup suffixes
  2. Removes empty directories from the original location
  3. Renames backup files to include their extension
  4. Organizes files in workdir by date (year/month)

Examples:
  $(basename "$0")

Output:
  Files are organized in workdir/YEAR/MONTH directories based on modification date
  Backup files have their extensions restored before sorting

EOF
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_help
    exit 0
fi

IFS=$'\n'
mkdir workdir

find . -type f -print0 | xargs -0 mv --backup=t  -t workdir/

find . -type d -empty -print -delete


cd workdir/

for i in $(find . -name "*.~*~"  -type f);do ext=$(echo $i| awk -F. '{ print $(NF-1) }') ; mv -n $i $i.$ext ;done

FILE=$(find . -type f -printf "%TY/%Tm/%Td_%TH_%TM_%TS_%f\n")

for i in $FILE;do

	DIR=$(echo $i |cut -d"/" -f 1-2)

	if [ ! -f $i ];then
		mkdir --parent $DIR
		mv --backup=t $(echo $i | cut -d'_' -f5-99) $i
	else
		echo file exists
	fi

done
